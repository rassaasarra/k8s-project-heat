---
# roles/monitoring/tasks/main.yml

# ==============================
# Guard: monitoring only on master
# ==============================
- name: Stop if not master
  meta: end_play
  when: k8s_role != "master"

# ==============================
# Kubeconfig for ubuntu user
# ==============================
- name: CrÃ©er le dossier .kube pour ubuntu
  file:
    path: /home/ubuntu/.kube
    state: directory
    owner: ubuntu
    group: ubuntu
    mode: "0700"
  become: yes

- name: Copier admin.conf vers kubeconfig ubuntu
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/ubuntu/.kube/config
    remote_src: yes
    owner: ubuntu
    group: ubuntu
    mode: "0600"
  become: yes

# ==============================
# Helm install
# ==============================
- name: VÃ©rifier si helm existe
  command: helm version --short
  register: helm_check
  failed_when: false
  changed_when: false
  become: yes

- name: Installer Helm si absent
  shell: |
    set -e
    curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
  args:
    executable: /bin/bash
  when: helm_check.rc != 0
  become: yes

# ==============================
# Deploy kube-prometheus-stack
# ==============================
- name: Ajouter repo prometheus-community
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
    helm repo update
  args:
    executable: /bin/bash
  become: yes

- name: CrÃ©er namespace monitoring si absent
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl get ns monitoring >/dev/null 2>&1 || kubectl create ns monitoring
  args:
    executable: /bin/bash
  become: yes

- name: DÃ©ployer kube-prometheus-stack
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
      --namespace monitoring \
      --create-namespace
  args:
    executable: /bin/bash
  register: helm_out
  become: yes

- name: Fail si helm a Ã©chouÃ©
  fail:
    msg: |
      Helm failed (rc={{ helm_out.rc }}):
      STDOUT={{ helm_out.stdout | default('') }}
      STDERR={{ helm_out.stderr | default('') }}
  when: helm_out.rc != 0

# ==============================
# Wait for key pods
# ==============================
- name: Attendre que les pods monitoring soient Ready
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n monitoring wait --for=condition=Ready pod --all --timeout=600s
  args:
    executable: /bin/bash
  register: wait_mon
  retries: 6
  delay: 20
  until: wait_mon.rc == 0
  become: yes

# ==============================
# Print useful info
# ==============================
- name: RÃ©cupÃ©rer le mot de passe Grafana (admin)
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n monitoring get secret prometheus-grafana -o jsonpath="{.data.admin-password}" | base64 -d
  args:
    executable: /bin/bash
  register: grafana_pass
  changed_when: false
  failed_when: false
  become: yes

- name: Afficher les commandes de test (Grafana/Prometheus)
  debug:
    msg: |
      âœ… Monitoring installÃ©.

      ðŸ” Grafana credentials:
      - user: admin
      - password: {{ grafana_pass.stdout | default('N/A') }}

      ðŸŒ Port-forward (depuis le master):
      1) Grafana:
         kubectl -n monitoring port-forward svc/prometheus-grafana 3000:80 --address 0.0.0.0
         => http://<MASTER_IP>:3000

      2) Prometheus:
         kubectl -n monitoring port-forward svc/prometheus-kube-prometheus-prometheus 9090:9090 --address 0.0.0.0
         => http://<MASTER_IP>:9090

      ðŸ”Ž VÃ©rifs:
      - kubectl get pods -n monitoring -o wide
      - kubectl get svc -n monitoring
      - kubectl get events -n monitoring --sort-by=.lastTimestamp | tail -40
