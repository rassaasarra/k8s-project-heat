# roles/monitoring/tasks/main.yml

- name: Stop if not master
  meta: end_play
  when: k8s_role != "master"

- name: Installer Helm si absent
  become: yes
  shell: |
    set -e
    if ! command -v helm >/dev/null 2>&1; then
      curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    fi
  args:
    executable: /bin/bash
  changed_when: false

- name: Ajouter repo prometheus-community
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
    helm repo update
  args:
    executable: /bin/bash
  changed_when: false

- name: Cr√©er namespace monitoring si absent
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl get ns monitoring >/dev/null 2>&1 || kubectl create ns monitoring
  args:
    executable: /bin/bash
  changed_when: false

- name: D√©ployer kube-prometheus-stack
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
      --namespace monitoring \
      --create-namespace
  args:
    executable: /bin/bash
  register: helm_out
  retries: 5
  delay: 20
  until: helm_out.rc == 0

- name: Attendre l'operator Prometheus
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n monitoring wait --for=condition=Available deploy \
      -l app.kubernetes.io/name=kube-prometheus-stack-prometheus-operator \
      --timeout=600s
  args:
    executable: /bin/bash
  register: op_wait
  retries: 6
  delay: 20
  until: op_wait.rc == 0
  changed_when: false

- name: Attendre Grafana Ready
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n monitoring wait --for=condition=Ready pod \
      -l app.kubernetes.io/name=grafana \
      --timeout=600s
  args:
    executable: /bin/bash
  register: graf_wait
  retries: 6
  delay: 20
  until: graf_wait.rc == 0
  changed_when: false

- name: R√©cup√©rer le mot de passe Grafana (admin)
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n monitoring get secret prometheus-grafana -o jsonpath="{.data.admin-password}" | base64 -d
  args:
    executable: /bin/bash
  register: grafana_pass
  changed_when: false
  failed_when: false

- name: Afficher infos Grafana
  debug:
    msg: |
      ‚úÖ Monitoring install√©.
      üîê Grafana: admin / {{ grafana_pass.stdout | default('N/A') }}
      üåê Port-forward:
        kubectl -n monitoring port-forward svc/prometheus-grafana 3000:80 --address 0.0.0.0
        http://<MASTER_IP>:3000
