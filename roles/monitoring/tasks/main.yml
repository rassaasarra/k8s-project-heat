---
# ========================================
# Deploy Monitoring Stack on Master
# ========================================

- name: Wait for Kubernetes cluster to be ready
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl get nodes
  register: nodes_status
  until: nodes_status.rc == 0
  retries: 30
  delay: 10
  when: node_role == 'master'

- name: Check if all nodes are Ready
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl get nodes --no-headers | awk '{print $2}' | grep -v Ready
  register: nodes_not_ready
  failed_when: false
  changed_when: false
  when: node_role == 'master'

- name: Wait for all nodes to be Ready
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl wait --for=condition=Ready nodes --all --timeout=300s
  when: 
    - node_role == 'master'
    - nodes_not_ready.stdout != ""
  ignore_errors: yes

- name: Install Helm
  shell: |
    if ! command -v helm &> /dev/null; then
       curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    fi
  changed_when: false
  when: node_role == 'master'

- name: Create monitoring namespace
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl create namespace monitoring --dry-run=client -o yaml | kubectl apply -f -
  when: node_role == 'master'

- name: Add Prometheus Helm repository
  shell: |
    helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
    helm repo update
  changed_when: false
  when: node_role == 'master'

- name: Deploy kube-prometheus-stack
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \\
      --namespace monitoring \\
      --create-namespace \\
      --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false \\
      --set grafana.adminPassword=admin \\
      --set grafana.service.type=NodePort \\
      --set grafana.service.nodePort=30300 \\
      --set prometheus.service.type=NodePort \\
      --set prometheus.service.nodePort=30900 \\
      --set alertmanager.service.type=NodePort \\
      --set alertmanager.service.nodePort=30093 \\
      --timeout 10m \\
      --wait
  register: helm_out
  failed_when: "helm_out.rc != 0 and 'already exists' not in helm_out.stderr"
  when: node_role == 'master'

- name: Create custom alert rules
  copy:
    dest: /tmp/prometheus-alerts.yaml
    content: |
      apiVersion: monitoring.coreos.com/v1
      kind: PrometheusRule
      metadata:
        name: custom-k8s-alerts
        namespace: monitoring
        labels:
          prometheus: kube-prometheus-stack-prometheus
          role: alert-rules
      spec:
        groups:
        - name: pod-alerts
          interval: 30s
          rules:
          - alert: PodHighCPUUsage
            expr: |
              sum(rate(container_cpu_usage_seconds_total{pod!="",namespace!="kube-system"}[5m])) by (pod, namespace) > 0.8
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "Pod {{ $labels.pod }} high CPU usage"
              description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is using more than 80% CPU for 2 minutes"
          
          - alert: PodHighMemoryUsage
            expr: |
              sum(container_memory_working_set_bytes{pod!="",namespace!="kube-system"}) by (pod, namespace) / 
              sum(container_spec_memory_limit_bytes{pod!="",namespace!="kube-system"} > 0) by (pod, namespace) > 0.85
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "Pod {{ $labels.pod }} high memory usage"
              description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} is using more than 85% of memory limit"

        - name: node-alerts
          interval: 30s
          rules:
          - alert: NodeHighCPU
            expr: |
              100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Node {{ $labels.instance }} high CPU"
              description: "Node CPU usage above 80% for 5 minutes"
          
          - alert: NodeHighMemory
            expr: |
              (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
            for: 5m
            labels:
              severity: critical
            annotations:
              summary: "Node {{ $labels.instance }} high memory"
              description: "Node memory usage above 85%"
          
          - alert: NodeDiskSpaceLow
            expr: |
              (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 15
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Node {{ $labels.instance }} low disk space"
              description: "Node has less than 15% disk space available"
  when: node_role == 'master'

- name: Apply custom alert rules
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl apply -f /tmp/prometheus-alerts.yaml
  when: node_role == 'master'

- name: Wait for Prometheus pods to be ready
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=prometheus -n monitoring --timeout=600s
  when: node_role == 'master'
  ignore_errors: yes

- name: Wait for Grafana pods to be ready
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl wait --for=condition=Ready pods -l app.kubernetes.io/name=grafana -n monitoring --timeout=600s
  when: node_role == 'master'
  ignore_errors: yes

- name: Display monitoring access information
  debug:
    msg:
      - "============================================"
      - "Monitoring Stack Deployed Successfully!"
      - "============================================"
      - "Access Grafana: http://<MASTER_FLOATING_IP>:30300"
      - "  Username: admin"
      - "  Password: admin"
      - ""
      - "Access Prometheus: http://<MASTER_FLOATING_IP>:30900"
      - "Access Alertmanager: http://<MASTER_FLOATING_IP>:30093"
      - "============================================"
  when: node_role == 'master'
