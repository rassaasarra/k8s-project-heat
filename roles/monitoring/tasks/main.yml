---
- name: Stop if not master
  meta: end_play
  when: k8s_role != "master"

# ==============================
# ATTENDRE QUE LES WORKERS REJOIGNENT
# AVANT d'installer le monitoring
# ==============================

- name: Attendre que les workers rejoignent le cluster (3 nodes Ready)
  become: yes
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    COUNT=$(kubectl get nodes --no-headers 2>/dev/null | grep -c Ready || echo 0)
    echo "Nodes Ready: $COUNT/3"
    until [ "$COUNT" -ge 3 ]; do
      echo "Waiting for workers... $COUNT/3 Ready"
      kubectl get nodes --no-headers 2>/dev/null || true
      sleep 20
      COUNT=$(kubectl get nodes --no-headers 2>/dev/null | grep -c Ready || echo 0)
    done
    echo "âœ… Les 3 nodes sont Ready !"
    kubectl get nodes
  args:
    executable: /bin/bash
  timeout: 1800
  changed_when: false

# ==============================
# INSTALLATION HELM
# ==============================

- name: Installer Helm si absent
  become: yes
  shell: |
    set -e
    if ! command -v helm >/dev/null 2>&1; then
      curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    fi
    helm version --short >/dev/null
  args:
    executable: /bin/bash
  changed_when: false

- name: Ajouter repo prometheus-community
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
    helm repo add grafana https://grafana.github.io/helm-charts || true
    helm repo update
  args:
    executable: /bin/bash
  changed_when: false

# ==============================
# NAMESPACE MONITORING
# ==============================

- name: CrÃ©er namespace monitoring si absent
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl get ns monitoring >/dev/null 2>&1 || kubectl create ns monitoring
  args:
    executable: /bin/bash
  changed_when: false

# ==============================
# DEPLOIEMENT KUBE-PROMETHEUS-STACK
# AVEC SIDECAR DASHBOARDS ACTIVÃ‰
# ==============================

- name: DÃ©ployer kube-prometheus-stack (Grafana NodePort 30000 + Sidecar)
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
      --namespace monitoring \
      --create-namespace \
      --set grafana.enabled=true \
      --set grafana.service.type=NodePort \
      --set grafana.service.nodePort=30000 \
      --set grafana.adminUser=admin \
      --set grafana.sidecar.dashboards.enabled=true \
      --set grafana.sidecar.dashboards.label=grafana_dashboard \
      --set-string grafana.sidecar.dashboards.labelValue="1" \
      --set grafana.sidecar.dashboards.searchNamespace=ALL \
      --set kubeEtcd.enabled=false \
      --set kubeControllerManager.enabled=false \
      --set kubeScheduler.enabled=false \
      --wait \
      --timeout 15m
  args:
    executable: /bin/bash
  register: helm_out
  retries: 3
  delay: 20
  until: helm_out.rc == 0

# ==============================
# ATTENDRE QUE TOUT SOIT READY
# ==============================

- name: Attendre l'operator Prometheus
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n monitoring wait --for=condition=Available deploy \
      -l app.kubernetes.io/name=kube-prometheus-stack-prometheus-operator \
      --timeout=600s
  args:
    executable: /bin/bash
  register: op_wait
  retries: 6
  delay: 20
  until: op_wait.rc == 0
  changed_when: false

- name: Attendre Grafana Ready
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n monitoring wait --for=condition=Ready pod \
      -l app.kubernetes.io/name=grafana \
      --timeout=600s
  args:
    executable: /bin/bash
  register: graf_wait
  retries: 6
  delay: 20
  until: graf_wait.rc == 0
  changed_when: false

# ==============================
# DASHBOARD IA - PREDICTIONS ET ANOMALIES
# ==============================

- name: DÃ©ployer le Dashboard IA Monitoring
  become: yes
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl apply -f /tmp/ai-dashboard.yaml
  args:
    executable: /bin/bash
  changed_when: false
  ignore_errors: yes

- name: CrÃ©er le fichier ConfigMap dashboard IA
  copy:
    dest: /tmp/ai-dashboard.yaml
    mode: '0644'
    content: |
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: ai-monitoring-dashboard
        namespace: monitoring
        labels:
          grafana_dashboard: "1"
      data:
        ai-monitoring-dashboard.json: |
          {
            "annotations": { "list": [] },
            "editable": true,
            "graphTooltip": 1,
            "id": null,
            "links": [],
            "panels": [
              {
                "gridPos": { "h": 6, "w": 24, "x": 0, "y": 0 },
                "id": 1,
                "title": "RECOMMANDATIONS IA - Seuils et Alertes",
                "type": "text",
                "options": {
                  "mode": "markdown",
                  "content": "## Tableau des Seuils de Monitoring IA\n\n| Metrique | Normal | Attention | Critique | Action |\n|----------|--------|-----------|----------|---------|\n| **CPU** | < 60% | 60-80% | > 80% | Scale horizontalement |\n| **Memoire** | < 70% | 70-85% | > 85% | Augmenter les limites |\n| **Disque** | < 70% | 70-85% | > 85% | Nettoyer les logs |\n| **Z-Score** | < 2 | 2-3 | > 3 | Investiguer immediatement |\n| **Pod Restarts** | 0 | 1-3 | > 3 | Verifier les logs |\n| **HPA** | < max | = max 10min | = max 30min | Augmenter maxReplicas |"
                }
              },
              {
                "gridPos": { "h": 5, "w": 8, "x": 0, "y": 6 },
                "id": 2,
                "title": "PREDICTION CPU +1h",
                "type": "stat",
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "targets": [{ "expr": "predict_linear(avg(1 - rate(node_cpu_seconds_total{mode=\"idle\"}[5m]))[30m:1m], 3600) * 100", "legendFormat": "CPU predit +1h", "refId": "A" }],
                "fieldConfig": { "defaults": { "unit": "percent", "thresholds": { "mode": "absolute", "steps": [{"color":"green","value":null},{"color":"yellow","value":60},{"color":"red","value":80}] }, "min": 0, "max": 100 } },
                "options": { "colorMode": "background", "graphMode": "area", "textMode": "auto", "reduceOptions": {"calcs": ["lastNotNull"]} }
              },
              {
                "gridPos": { "h": 5, "w": 8, "x": 8, "y": 6 },
                "id": 3,
                "title": "PREDICTION DISQUE +24h",
                "type": "stat",
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "targets": [{ "expr": "predict_linear(avg(1 - node_filesystem_avail_bytes{mountpoint=\"/\"} / node_filesystem_size_bytes{mountpoint=\"/\"})[1h:5m], 86400) * 100", "legendFormat": "Disque predit +24h", "refId": "A" }],
                "fieldConfig": { "defaults": { "unit": "percent", "thresholds": { "mode": "absolute", "steps": [{"color":"green","value":null},{"color":"yellow","value":70},{"color":"red","value":85}] }, "min": 0, "max": 100 } },
                "options": { "colorMode": "background", "graphMode": "area", "textMode": "auto", "reduceOptions": {"calcs": ["lastNotNull"]} }
              },
              {
                "gridPos": { "h": 5, "w": 8, "x": 16, "y": 6 },
                "id": 4,
                "title": "PREDICTION MEMOIRE +1h",
                "type": "stat",
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "targets": [{ "expr": "predict_linear(avg(1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)[30m:1m], 3600) * 100", "legendFormat": "Memoire predite +1h", "refId": "A" }],
                "fieldConfig": { "defaults": { "unit": "percent", "thresholds": { "mode": "absolute", "steps": [{"color":"green","value":null},{"color":"yellow","value":70},{"color":"red","value":85}] }, "min": 0, "max": 100 } },
                "options": { "colorMode": "background", "graphMode": "area", "textMode": "auto", "reduceOptions": {"calcs": ["lastNotNull"]} }
              },
              {
                "gridPos": { "h": 5, "w": 8, "x": 0, "y": 11 },
                "id": 5,
                "title": "Cluster Health Score",
                "type": "gauge",
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "targets": [{ "expr": "sum(kube_node_status_condition{condition=\"Ready\",status=\"true\"}) / count(kube_node_info) * 100", "legendFormat": "Health %", "refId": "A" }],
                "fieldConfig": { "defaults": { "unit": "percent", "min": 0, "max": 100, "thresholds": { "mode": "absolute", "steps": [{"color":"red","value":null},{"color":"yellow","value":50},{"color":"green","value":80}] } } },
                "options": { "reduceOptions": {"calcs": ["lastNotNull"]}, "showThresholdLabels": false, "showThresholdMarkers": true }
              },
              {
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 19 },
                "id": 8,
                "title": "Detection Anomalies CPU Z-Score",
                "type": "timeseries",
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "targets": [{ "expr": "(\n  (1 - rate(node_cpu_seconds_total{mode=\"idle\"}[5m]))\n  - avg_over_time((1 - rate(node_cpu_seconds_total{mode=\"idle\"}[5m]))[1h:5m])\n) / stddev_over_time((1 - rate(node_cpu_seconds_total{mode=\"idle\"}[5m]))[1h:5m])", "legendFormat": "Z-Score CPU", "refId": "A" }],
                "fieldConfig": { "defaults": { "custom": { "lineWidth": 2, "fillOpacity": 10, "spanNulls": true, "thresholdsStyle": {"mode":"line"} }, "thresholds": { "mode": "absolute", "steps": [{"color":"green","value":null},{"color":"yellow","value":2},{"color":"red","value":3}] } } },
                "options": { "tooltip": {"mode":"multi"}, "legend": {"displayMode":"table","placement":"bottom"} }
              },
              {
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 19 },
                "id": 9,
                "title": "Detection Anomalies Memoire Z-Score",
                "type": "timeseries",
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "targets": [{ "expr": "(\n  (1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)\n  - avg_over_time((1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)[1h:5m])\n) / stddev_over_time((1 - node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)[1h:5m])", "legendFormat": "Z-Score Memoire", "refId": "A" }],
                "fieldConfig": { "defaults": { "custom": { "lineWidth": 2, "fillOpacity": 10, "spanNulls": true, "thresholdsStyle": {"mode":"line"} }, "thresholds": { "mode": "absolute", "steps": [{"color":"green","value":null},{"color":"yellow","value":2},{"color":"red","value":3}] } } },
                "options": { "tooltip": {"mode":"multi"}, "legend": {"displayMode":"table","placement":"bottom"} }
              },
              {
                "gridPos": { "h": 8, "w": 12, "x": 0, "y": 27 },
                "id": 10,
                "title": "HPA Autoscaling Replicas",
                "type": "timeseries",
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "targets": [
                  { "expr": "kube_horizontalpodautoscaler_status_current_replicas", "legendFormat": "Current - {{horizontalpodautoscaler}}", "refId": "A" },
                  { "expr": "kube_horizontalpodautoscaler_spec_max_replicas", "legendFormat": "Max - {{horizontalpodautoscaler}}", "refId": "B" },
                  { "expr": "kube_horizontalpodautoscaler_spec_min_replicas", "legendFormat": "Min - {{horizontalpodautoscaler}}", "refId": "C" }
                ],
                "fieldConfig": { "defaults": { "custom": { "lineWidth": 2, "fillOpacity": 5, "spanNulls": true }, "decimals": 0, "min": 0 } },
                "options": { "tooltip": {"mode":"multi"}, "legend": {"displayMode":"table","placement":"bottom"} }
              },
              {
                "gridPos": { "h": 8, "w": 12, "x": 12, "y": 27 },
                "id": 11,
                "title": "Restarts Pods Crash Detection",
                "type": "timeseries",
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "targets": [{ "expr": "increase(kube_pod_container_status_restarts_total[15m])", "legendFormat": "{{pod}} - {{container}}", "refId": "A" }],
                "fieldConfig": { "defaults": { "custom": { "lineWidth": 2, "fillOpacity": 15, "spanNulls": true, "thresholdsStyle": {"mode":"line"} }, "decimals": 0, "min": 0, "thresholds": { "mode": "absolute", "steps": [{"color":"green","value":null},{"color":"yellow","value":1},{"color":"red","value":3}] } } },
                "options": { "tooltip": {"mode":"multi"}, "legend": {"displayMode":"table","placement":"bottom"} }
              },
              {
                "gridPos": { "h": 8, "w": 24, "x": 0, "y": 35 },
                "id": 12,
                "title": "Alertes Actives",
                "type": "table",
                "datasource": { "type": "prometheus", "uid": "prometheus" },
                "targets": [{ "expr": "ALERTS{alertstate=\"firing\"}", "format": "table", "instant": true, "refId": "A" }],
                "fieldConfig": { "defaults": {} },
                "options": { "showHeader": true }
              }
            ],
            "refresh": "30s",
            "schemaVersion": 38,
            "style": "dark",
            "tags": ["ai", "monitoring", "prediction", "anomaly-detection"],
            "time": { "from": "now-3h", "to": "now" },
            "title": "AI Monitoring - Predictions et Anomalies",
            "uid": "ai-monitoring-dashboard",
            "version": 1
          }
  become: yes

- name: Appliquer le dashboard IA
  become: yes
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl apply -f /tmp/ai-dashboard.yaml
  args:
    executable: /bin/bash
  changed_when: false
  ignore_errors: yes

- name: Confirmer le dashboard IA dÃ©ployÃ©
  debug:
    msg: "âœ… Dashboard IA dÃ©ployÃ© ! Grafana â†’ Dashboards â†’ AI Monitoring - Predictions et Anomalies"

# ==============================
# PORT-FORWARD AUTOMATIQUE GRAFANA
# ==============================

- name: CrÃ©er service systemd pour port-forward Grafana
  copy:
    dest: /etc/systemd/system/grafana-portforward.service
    mode: '0644'
    content: |
      [Unit]
      Description=Grafana Port Forward - K8s Monitoring
      After=network.target

      [Service]
      ExecStart=/usr/bin/kubectl -n monitoring port-forward svc/prometheus-grafana 3000:80 --address 0.0.0.0
      Restart=always
      RestartSec=10
      Environment=KUBECONFIG=/etc/kubernetes/admin.conf

      [Install]
      WantedBy=multi-user.target
  become: yes

- name: Activer et dÃ©marrer grafana-portforward
  systemd:
    name: grafana-portforward
    enabled: yes
    state: started
    daemon_reload: yes
  become: yes

- name: Attendre que le port-forward soit prÃªt
  wait_for:
    host: 0.0.0.0
    port: 3000
    timeout: 30
  become: yes

# ==============================
# RECUPERER LES INFOS D'ACCES
# ==============================

- name: RÃ©cupÃ©rer le mot de passe Grafana
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n monitoring get secret prometheus-grafana \
      -o jsonpath="{.data.admin-password}" | base64 -d
  args:
    executable: /bin/bash
  register: grafana_pass
  changed_when: false
  failed_when: false

- name: RÃ©cupÃ©rer le NodePort Grafana
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n monitoring get svc prometheus-grafana \
      -o jsonpath="{.spec.ports[0].nodePort}"
  args:
    executable: /bin/bash
  register: grafana_nodeport
  changed_when: false
  failed_when: false

- name: RÃ©cupÃ©rer l'IP du master
  become: yes
  shell: |
    hostname -I | awk '{print $1}'
  args:
    executable: /bin/bash
  register: master_ip_addr
  changed_when: false

# ==============================
# AFFICHER LES INFOS FINALES
# ==============================

- name: Afficher infos Grafana
  debug:
    msg: |
      âœ… Monitoring installÃ© avec succÃ¨s.
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸ” Grafana login : admin
      ğŸ” Grafana pass  : {{ grafana_pass.stdout | default('N/A') }}
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸŒ AccÃ¨s via tunnel SSH depuis le controller:
         ssh -i ~/.ssh/id_ed25519 ubuntu@<FLOATING_IP> -L 0.0.0.0:3001:localhost:3000 -N &
         http://192.168.18.10:3001
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸ“Š Dashboard IA:
         Grafana â†’ Dashboards â†’ AI Monitoring - Predictions et Anomalies
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸ” VÃ©rification:
         kubectl -n monitoring get pods
         kubectl -n monitoring get svc
         systemctl status grafana-portforward
