---
- name: Stop if not master
  meta: end_play
  when: k8s_role != "master"

# ==============================
# ATTENDRE QUE LES WORKERS REJOIGNENT
# AVANT d'installer le monitoring
# ==============================

- name: Attendre que les workers rejoignent le cluster (3 nodes Ready)
  become: yes
  shell: |
    export KUBECONFIG=/etc/kubernetes/admin.conf
    COUNT=$(kubectl get nodes --no-headers 2>/dev/null | grep -c Ready || echo 0)
    echo "Nodes Ready: $COUNT/3"
    until [ "$COUNT" -ge 3 ]; do
      echo "Waiting for workers... $COUNT/3 Ready"
      kubectl get nodes --no-headers 2>/dev/null || true
      sleep 20
      COUNT=$(kubectl get nodes --no-headers 2>/dev/null | grep -c Ready || echo 0)
    done
    echo "âœ… Les 3 nodes sont Ready !"
    kubectl get nodes
  args:
    executable: /bin/bash
  timeout: 1800
  changed_when: false

# ==============================
# INSTALLATION HELM
# ==============================

- name: Installer Helm si absent
  become: yes
  shell: |
    set -e
    if ! command -v helm >/dev/null 2>&1; then
      curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    fi
    helm version --short >/dev/null
  args:
    executable: /bin/bash
  changed_when: false

- name: Ajouter repo prometheus-community
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
    helm repo add grafana https://grafana.github.io/helm-charts || true
    helm repo update
  args:
    executable: /bin/bash
  changed_when: false

# ==============================
# NAMESPACE MONITORING
# ==============================

- name: CrÃ©er namespace monitoring si absent
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl get ns monitoring >/dev/null 2>&1 || kubectl create ns monitoring
  args:
    executable: /bin/bash
  changed_when: false

# ==============================
# DEPLOIEMENT KUBE-PROMETHEUS-STACK
# ==============================

- name: DÃ©ployer kube-prometheus-stack (Grafana NodePort 30000)
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
      --namespace monitoring \
      --create-namespace \
      --set grafana.enabled=true \
      --set grafana.service.type=NodePort \
      --set grafana.service.nodePort=30000 \
      --set grafana.adminUser=admin \
      --set kubeEtcd.enabled=false \
      --set kubeControllerManager.enabled=false \
      --set kubeScheduler.enabled=false \
      --wait \
      --timeout 15m
  args:
    executable: /bin/bash
  register: helm_out
  retries: 3
  delay: 20
  until: helm_out.rc == 0

# ==============================
# ATTENDRE QUE TOUT SOIT READY
# ==============================

- name: Attendre l'operator Prometheus
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n monitoring wait --for=condition=Available deploy \
      -l app.kubernetes.io/name=kube-prometheus-stack-prometheus-operator \
      --timeout=600s
  args:
    executable: /bin/bash
  register: op_wait
  retries: 6
  delay: 20
  until: op_wait.rc == 0
  changed_when: false

- name: Attendre Grafana Ready
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n monitoring wait --for=condition=Ready pod \
      -l app.kubernetes.io/name=grafana \
      --timeout=600s
  args:
    executable: /bin/bash
  register: graf_wait
  retries: 6
  delay: 20
  until: graf_wait.rc == 0
  changed_when: false

# ==============================
# PORT-FORWARD AUTOMATIQUE GRAFANA
# Accessible depuis l'extÃ©rieur via port 3000
# ==============================

- name: CrÃ©er service systemd pour port-forward Grafana
  copy:
    dest: /etc/systemd/system/grafana-portforward.service
    mode: '0644'
    content: |
      [Unit]
      Description=Grafana Port Forward - K8s Monitoring
      After=network.target

      [Service]
      ExecStart=/usr/bin/kubectl -n monitoring port-forward svc/prometheus-grafana 3000:80 --address 0.0.0.0
      Restart=always
      RestartSec=10
      Environment=KUBECONFIG=/etc/kubernetes/admin.conf

      [Install]
      WantedBy=multi-user.target
  become: yes

- name: Activer et dÃ©marrer grafana-portforward
  systemd:
    name: grafana-portforward
    enabled: yes
    state: started
    daemon_reload: yes
  become: yes

- name: Attendre que le port-forward soit prÃªt
  wait_for:
    host: 0.0.0.0
    port: 3000
    timeout: 30
  become: yes

# ==============================
# RECUPERER LES INFOS D'ACCES
# ==============================

- name: RÃ©cupÃ©rer le mot de passe Grafana
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n monitoring get secret prometheus-grafana \
      -o jsonpath="{.data.admin-password}" | base64 -d
  args:
    executable: /bin/bash
  register: grafana_pass
  changed_when: false
  failed_when: false

- name: RÃ©cupÃ©rer le NodePort Grafana
  become: yes
  shell: |
    set -e
    export KUBECONFIG=/etc/kubernetes/admin.conf
    kubectl -n monitoring get svc prometheus-grafana \
      -o jsonpath="{.spec.ports[0].nodePort}"
  args:
    executable: /bin/bash
  register: grafana_nodeport
  changed_when: false
  failed_when: false

- name: RÃ©cupÃ©rer l'IP du master
  become: yes
  shell: |
    hostname -I | awk '{print $1}'
  args:
    executable: /bin/bash
  register: master_ip_addr
  changed_when: false

# ==============================
# AFFICHER LES INFOS FINALES
# ==============================

- name: Afficher infos Grafana
  debug:
    msg: |
      âœ… Monitoring installÃ© avec succÃ¨s.
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸ” Grafana login : admin
      ğŸ” Grafana pass  : {{ grafana_pass.stdout | default('N/A') }}
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸŒ AccÃ¨s via tunnel SSH depuis le controller:
         ssh -i ~/.ssh/id_ed25519 ubuntu@<FLOATING_IP> -L 0.0.0.0:3001:localhost:3000 -N &
         http://192.168.18.10:3001
      â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      ğŸ” VÃ©rification:
         kubectl -n monitoring get pods
         kubectl -n monitoring get svc
         systemctl status grafana-portforward
