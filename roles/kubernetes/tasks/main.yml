---
# 1. Protection contre les verrous APT & Réparations
# -------------------------------------------------------------------------
- name: Attendre que le verrou APT soit libéré
  shell: while fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 5; done;
  changed_when: false

- name: Réparer les installations de paquets interrompues
  shell: |
    dpkg --configure -a
    apt-get install -f -y
  ignore_errors: yes
  become: yes

# 2. Préparation du Système (Swap, Modules, Réseau)
# -------------------------------------------------------------------------
- name: Désactiver le Swap
  shell: |
    swapoff -a
    sed -i '/\sswap\s/ s/^\(.*\)$/#\1/g' /etc/fstab
  become: yes

- name: Charger les modules noyau
  modprobe:
    name: "{{ item }}"
    state: present
  loop: [overlay, br_netfilter]
  become: yes

- name: Configurer le sysctl pour le réseau
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
    - { key: 'net.ipv4.ip_forward', value: '1' }
  become: yes

# 3. Installation Docker & CRI-Dockerd
# -------------------------------------------------------------------------
- name: Installer Docker et dépendances
  apt:
    name: [docker.io, apt-transport-https, curl, jq, gnupg]
    state: present
    update_cache: yes
  become: yes

- name: Configurer le répertoire des clés
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  become: yes

- name: Gestion de cri-dockerd
  block:
    - name: Télécharger cri-dockerd
      get_url:
        url: https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.10/cri-dockerd_0.3.10.3-0.ubuntu-jammy_amd64.deb
        dest: /tmp/cri-dockerd.deb

    - name: Installer le paquet deb via dpkg (pour supporter zstd)
      shell: dpkg -i /tmp/cri-dockerd.deb || apt-get install -f -y
      become: yes

    - name: Redémarrer les services
      systemd:
        name: "{{ item }}"
        state: restarted
        enabled: yes
        daemon_reload: yes
      loop: [docker, cri-docker]
  become: yes

# 4. Installation de Kubernetes (v1.28)
# -------------------------------------------------------------------------
- name: Configurer le dépôt K8s
  shell: |
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor --yes -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /" > /etc/apt/sources.list.d/kubernetes.list
  become: yes

- name: Installer kubelet, kubeadm, kubectl
  apt:
    name: [kubelet, kubeadm, kubectl]
    state: present
    update_cache: yes
  become: yes

# 5. Initialisation du MASTER
# -------------------------------------------------------------------------
- name: Initialiser le Master Kubernetes
  command: >
    kubeadm init 
    --pod-network-cidr=192.168.0.0/16 
    --apiserver-advertise-address=10.0.0.34
    --apiserver-cert-extra-sans=10.0.0.34
    --cri-socket unix:///var/run/cri-dockerd.sock
    --ignore-preflight-errors=all
  args:
    creates: /etc/kubernetes/admin.conf
  when: k8s_role == 'master'
  become: yes

- name: Setup kubeconfig pour root
  block:
    - file: path=/root/.kube state=directory
    - copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: yes
  when: k8s_role == 'master'
  become: yes

- name: Installer Calico (Réseau)
  shell: |
    kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/tigera-operator.yaml
    sleep 5
    kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.0/manifests/custom-resources.yaml
  when: k8s_role == 'master'
  become: yes
  ignore_errors: yes

# 6. Logique WORKER
# -------------------------------------------------------------------------
- name: Nettoyer avant jointure
  command: kubeadm reset -f
  when: k8s_role == 'worker' and join_command is defined
  become: yes
  args:
    creates: /etc/kubernetes/kubelet.conf

- name: Joindre le Worker au Cluster
  shell: "{{ join_command }} --cri-socket unix:///var/run/cri-dockerd.sock"
  when: k8s_role == 'worker' and join_command is defined
  become: yes
  args:
    creates: /etc/kubernetes/kubelet.conf
