---
# ==============================
# FIX APT LOCKS
# ==============================
- name: Stop unattended-upgrades service
  service:
    name: unattended-upgrades
    state: stopped
    enabled: no
  become: yes
  [cite_start]ignore_errors: yes [cite: 13]

- name: Disable apt daily timers
  shell: |
    systemctl disable --now apt-daily.timer apt-daily-upgrade.timer || true
  [cite_start]become: yes [cite: 13]

# ==============================
# SYSTEM PREREQUISITES
# ==============================
- name: Disable SWAP
  shell: |
    swapoff -a
    sed -i '/swap/d' /etc/fstab
  [cite_start]become: yes [cite: 13]

- name: Load Kernel Modules
  modprobe:
    name: "{{ item }}"
    state: present
  loop: [ 'br_netfilter', 'overlay' ]
  [cite_start]become: yes [cite: 13]

- name: Enable Network Forwarding
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: yes
  loop:
    - { key: 'net.ipv4.ip_forward', value: '1' }
    - { key: 'net.bridge.bridge-nf-call-iptables', value: '1' }
  [cite_start]become: yes [cite: 13]

# ==============================
# CONTAINERD RUNTIME
# ==============================
- name: Install Containerd
  apt:
    name: containerd
    state: present
    update_cache: yes
  [cite_start]become: yes [cite: 13]

- name: Configure Containerd (SystemdCgroup)
  shell: |
    mkdir -p /etc/containerd
    containerd config default > /etc/containerd/config.toml
    sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml
    systemctl restart containerd
  [cite_start]become: yes [cite: 13]

# ==============================
# KUBERNETES BINARIES
# ==============================
- name: Add Kubernetes Repository
  shell: |
    mkdir -p /etc/apt/keyrings
    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | gpg --dearmor --yes -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
    echo 'deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /' > /etc/apt/sources.list.d/kubernetes.list
  [cite_start]become: yes [cite: 13]

- name: Install Kubelet, Kubeadm, Kubectl
  apt:
    name: [kubelet, kubeadm, kubectl]
    state: present
    update_cache: yes
  [cite_start]become: yes [cite: 13]

# ==============================
# MASTER INITIALIZATION (Master Only)
# ==============================
- name: Initialize Kubernetes Master
  command: >
    kubeadm init 
    --pod-network-cidr=10.244.0.0/16 
    --cri-socket unix:///run/containerd/containerd.sock
  register: kube_init
  when: k8s_role == 'master'
  args:
    creates: /etc/kubernetes/admin.conf
  [cite_start]become: yes [cite: 13, 14]

- name: Setup Kubeconfig
  shell: |
    mkdir -p $HOME/.kube
    cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
    chown $(id -u):$(id -g) $HOME/.kube/config
  [cite_start]when: k8s_role == 'master' [cite: 13]

- name: Install Calico Network Plugin
  command: kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.3/manifests/calico.yaml
  when: k8s_role == 'master'
  [cite_start]become: no [cite: 13]
